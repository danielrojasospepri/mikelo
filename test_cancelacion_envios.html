<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîÑ Test Cancelaci√≥n de Env√≠os - Liberaci√≥n de Stock</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background-color: #f0f8ff;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .test-case {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background-color: #f9f9f9;
        }
        button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }
        button:hover { 
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .danger { background: linear-gradient(45deg, #f44336, #d32f2f); }
        .info { background: linear-gradient(45deg, #2196F3, #1976D2); }
        .warning { background: linear-gradient(45deg, #ff9800, #f57c00); }
        
        .result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
        }
        .success { background: #e8f5e8; border: 1px solid #4CAF50; }
        .error { background: #ffebee; border: 1px solid #f44336; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 12px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th { background-color: #f2f2f2; }
        
        .flow {
            background: #fff3e0;
            border: 1px solid #ff9800;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Test: Cancelaci√≥n de Env√≠os y Liberaci√≥n de Stock</h1>
        
        <div class="flow">
            <h3>üìã Flujo de Prueba:</h3>
            <ol>
                <li><strong>Estado inicial:</strong> Verificar productos disponibles</li>
                <li><strong>Crear env√≠o:</strong> Seleccionar productos (los saca del stock)</li>
                <li><strong>Verificar impacto:</strong> Productos ya no disponibles</li>
                <li><strong>Cancelar env√≠o:</strong> Con motivo espec√≠fico</li>
                <li><strong>Verificar liberaci√≥n:</strong> Productos vuelven al stock</li>
            </ol>
        </div>
        
        <div class="test-case">
            <h3>üìä Paso 1: Estado Inicial del Stock</h3>
            <button class="info" onclick="verificarProductosDisponibles()">Ver Productos Disponibles</button>
            <div id="resultadoInicial"></div>
        </div>
        
        <div class="test-case">
            <h3>üìã Paso 2: Lista de Env√≠os Actuales</h3>
            <button class="info" onclick="listarEnvios()">Ver Env√≠os Existentes</button>
            <div id="resultadoEnvios"></div>
        </div>
        
        <div class="test-case">
            <h3>‚ùå Paso 3: Cancelar Env√≠o (Liberar Stock)</h3>
            <p>Selecciona un env√≠o de la lista anterior para cancelar:</p>
            <input type="number" id="envioId" placeholder="ID del env√≠o" style="padding: 8px; margin: 5px;">
            <input type="text" id="motivoCancelacion" placeholder="Motivo de cancelaci√≥n" style="padding: 8px; margin: 5px; width: 200px;">
            <br>
            <button class="danger" onclick="cancelarEnvio()">‚ùå Cancelar Env√≠o</button>
            <div id="resultadoCancelacion"></div>
        </div>
        
        <div class="test-case">
            <h3>‚úÖ Paso 4: Verificar Liberaci√≥n del Stock</h3>
            <button class="info" onclick="verificarProductosLiberados()">üîÑ Verificar Productos Liberados</button>
            <div id="resultadoLiberacion"></div>
        </div>
        
        <div class="test-case">
            <h3>üß™ Paso 5: Test Completo Automatizado</h3>
            <p><strong>‚ö†Ô∏è Nota:</strong> Este test requiere que exista al menos un env√≠o en estado ENVIADO para cancelar.</p>
            <button class="warning" onclick="testCompletoAutomatizado()">üöÄ Ejecutar Test Completo</button>
            <div id="resultadoCompleto"></div>
        </div>
    </div>

    <script>
        let productosAntes = [];
        
        async function verificarProductosDisponibles() {
            try {
                const response = await fetch('api/envios/productos-disponibles');
                const data = await response.json();
                
                productosAntes = data.data || [];
                
                let html = `
                    <div class="result success">
                        <strong>‚úÖ Productos Disponibles (${productosAntes.length}):</strong><br>
                        <table>
                            <tr>
                                <th>ID Item</th>
                                <th>C√≥digo</th>
                                <th>Descripci√≥n</th>
                                <th>Cantidad</th>
                                <th>Peso</th>
                                <th>Estado</th>
                            </tr>
                `;
                
                productosAntes.forEach(producto => {
                    html += `
                        <tr>
                            <td>${producto.id_movimiento_item}</td>
                            <td>${producto.codigo}</td>
                            <td>${producto.descripcion}</td>
                            <td>${producto.cnt}</td>
                            <td>${producto.cnt_peso}kg</td>
                            <td>${producto.estado_actual}</td>
                        </tr>
                    `;
                });
                
                html += '</table></div>';
                document.getElementById('resultadoInicial').innerHTML = html;
                
            } catch (error) {
                document.getElementById('resultadoInicial').innerHTML = `
                    <div class="result error">‚ùå Error: ${error.message}</div>
                `;
            }
        }
        
        async function listarEnvios() {
            try {
                const response = await fetch('api/envios');
                const data = await response.json();
                
                if (data.success && data.data) {
                    let html = `
                        <div class="result success">
                            <strong>üìã Env√≠os Existentes (${data.data.length}):</strong><br>
                            <table>
                                <tr>
                                    <th>ID</th>
                                    <th>Fecha</th>
                                    <th>Origen</th>
                                    <th>Destino</th>
                                    <th>Estado</th>
                                    <th>Items</th>
                                </tr>
                    `;
                    
                    data.data.forEach(envio => {
                        html += `
                            <tr style="background-color: ${envio.ultimo_estado === 'ENVIADO' ? '#fff3e0' : '#f5f5f5'}">
                                <td><strong>${envio.id}</strong></td>
                                <td>${envio.fechaAlta}</td>
                                <td>${envio.origen}</td>
                                <td>${envio.destino}</td>
                                <td>${envio.ultimo_estado}</td>
                                <td>${envio.cantidad_items}</td>
                            </tr>
                        `;
                    });
                    
                    html += '</table>';
                    html += '<p><strong>üí° Tip:</strong> Los env√≠os en estado ENVIADO (fondo amarillo) pueden ser cancelados.</p>';
                    html += '</div>';
                    
                    document.getElementById('resultadoEnvios').innerHTML = html;
                } else {
                    throw new Error('No se pudieron obtener los env√≠os');
                }
                
            } catch (error) {
                document.getElementById('resultadoEnvios').innerHTML = `
                    <div class="result error">‚ùå Error: ${error.message}</div>
                `;
            }
        }
        
        async function cancelarEnvio() {
            const envioId = document.getElementById('envioId').value;
            const motivo = document.getElementById('motivoCancelacion').value;
            
            if (!envioId || !motivo) {
                Swal.fire('Error', 'Debe ingresar el ID del env√≠o y el motivo', 'error');
                return;
            }
            
            try {
                Swal.fire({
                    title: '‚è≥ Cancelando Env√≠o...',
                    text: 'Liberando productos al stock...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });
                
                const response = await fetch(`api/envios/${envioId}/cancelar`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ motivo: motivo })
                });
                
                const data = await response.json();
                Swal.close();
                
                if (data.success) {
                    document.getElementById('resultadoCancelacion').innerHTML = `
                        <div class="result success">
                            <strong>‚úÖ Env√≠o ${envioId} cancelado exitosamente</strong><br>
                            <strong>Motivo:</strong> ${motivo}<br>
                            <strong>Resultado:</strong> ${data.mensaje}<br>
                            <br>
                            <em>Los productos de este env√≠o han sido liberados y deber√≠an estar disponibles nuevamente en el stock.</em>
                        </div>
                    `;
                    
                    Swal.fire('‚úÖ Cancelado', 'Env√≠o cancelado y productos liberados', 'success');
                } else {
                    throw new Error(data.error || 'Error desconocido');
                }
                
            } catch (error) {
                Swal.close();
                document.getElementById('resultadoCancelacion').innerHTML = `
                    <div class="result error">‚ùå Error al cancelar: ${error.message}</div>
                `;
                Swal.fire('Error', error.message, 'error');
            }
        }
        
        async function verificarProductosLiberados() {
            try {
                const response = await fetch('api/envios/productos-disponibles');
                const data = await response.json();
                
                const productosDespues = data.data || [];
                const diferencia = productosDespues.length - productosAntes.length;
                
                let html = `
                    <div class="result ${diferencia > 0 ? 'success' : 'error'}">
                        <strong>üîÑ Comparaci√≥n de Stock:</strong><br>
                        <strong>Antes:</strong> ${productosAntes.length} productos disponibles<br>
                        <strong>Despu√©s:</strong> ${productosDespues.length} productos disponibles<br>
                        <strong>Diferencia:</strong> ${diferencia > 0 ? '+' : ''}${diferencia} productos<br>
                        <br>
                `;
                
                if (diferencia > 0) {
                    html += `<strong>‚úÖ ¬°√âxito! Se liberaron ${diferencia} productos al stock.</strong>`;
                } else if (diferencia === 0) {
                    html += `<strong>‚ö†Ô∏è No hay diferencia. Es posible que no se haya cancelado ning√∫n env√≠o.</strong>`;
                } else {
                    html += `<strong>‚ùå Advertencia: Se perdieron ${Math.abs(diferencia)} productos.</strong>`;
                }
                
                html += '<br><br><strong>Productos Actuales:</strong><table>';
                html += '<tr><th>ID</th><th>C√≥digo</th><th>Descripci√≥n</th><th>Cantidad</th><th>Estado</th></tr>';
                
                productosDespues.forEach(producto => {
                    const esNuevo = !productosAntes.find(p => p.id_movimiento_item === producto.id_movimiento_item);
                    html += `
                        <tr style="background-color: ${esNuevo ? '#e8f5e8' : 'white'}">
                            <td>${producto.id_movimiento_item}</td>
                            <td>${producto.codigo}</td>
                            <td>${producto.descripcion}</td>
                            <td>${producto.cnt}</td>
                            <td>${producto.estado_actual}</td>
                        </tr>
                    `;
                });
                
                html += '</table>';
                html += '<p><em>Los productos con fondo verde son los que se liberaron al cancelar el env√≠o.</em></p>';
                html += '</div>';
                
                document.getElementById('resultadoLiberacion').innerHTML = html;
                
            } catch (error) {
                document.getElementById('resultadoLiberacion').innerHTML = `
                    <div class="result error">‚ùå Error: ${error.message}</div>
                `;
            }
        }
        
        async function testCompletoAutomatizado() {
            document.getElementById('resultadoCompleto').innerHTML = `
                <div class="result info">‚è≥ Ejecutando test completo automatizado...</div>
            `;
            
            let resultado = '';
            
            try {
                // Paso 1: Stock inicial
                resultado += '<strong>üìä Paso 1: Stock inicial</strong><br>';
                await verificarProductosDisponibles();
                resultado += `‚úÖ Stock inicial: ${productosAntes.length} productos<br><br>`;
                
                // Paso 2: Buscar env√≠o para cancelar
                resultado += '<strong>üìã Paso 2: Buscar env√≠o ENVIADO</strong><br>';
                const enviosResponse = await fetch('api/envios');
                const enviosData = await enviosResponse.json();
                
                const envioEnviado = enviosData.data.find(e => e.ultimo_estado === 'ENVIADO');
                
                if (!envioEnviado) {
                    throw new Error('No hay env√≠os en estado ENVIADO para cancelar');
                }
                
                resultado += `‚úÖ Encontrado env√≠o ${envioEnviado.id} en estado ENVIADO<br><br>`;
                
                // Paso 3: Cancelar env√≠o
                resultado += '<strong>‚ùå Paso 3: Cancelar env√≠o</strong><br>';
                const cancelResponse = await fetch(`api/envios/${envioEnviado.id}/cancelar`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ motivo: 'Test automatizado - Verificaci√≥n de liberaci√≥n de stock' })
                });
                
                const cancelData = await cancelResponse.json();
                if (!cancelData.success) {
                    throw new Error(cancelData.error);
                }
                
                resultado += `‚úÖ Env√≠o ${envioEnviado.id} cancelado exitosamente<br><br>`;
                
                // Paso 4: Verificar liberaci√≥n
                resultado += '<strong>üîÑ Paso 4: Verificar liberaci√≥n</strong><br>';
                await verificarProductosLiberados();
                
                const stockResponse = await fetch('api/envios/productos-disponibles');
                const stockData = await stockResponse.json();
                const productosDespues = stockData.data || [];
                const diferencia = productosDespues.length - productosAntes.length;
                
                resultado += `‚úÖ Stock despu√©s: ${productosDespues.length} productos<br>`;
                resultado += `‚úÖ Productos liberados: ${diferencia}<br><br>`;
                
                if (diferencia > 0) {
                    resultado += '<strong>üéâ ¬°TEST EXITOSO! Los productos se liberaron correctamente al cancelar el env√≠o.</strong>';
                } else {
                    resultado += '<strong>‚ö†Ô∏è TEST INCOMPLETO: No se detectaron productos liberados.</strong>';
                }
                
                document.getElementById('resultadoCompleto').innerHTML = `
                    <div class="result success">
                        <strong>üß™ Resultado del Test Automatizado:</strong><br><br>
                        ${resultado}
                    </div>
                `;
                
            } catch (error) {
                document.getElementById('resultadoCompleto').innerHTML = `
                    <div class="result error">
                        <strong>‚ùå Test Fall√≥:</strong><br><br>
                        ${resultado}<br>
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            }
        }
    </script>
</body>
</html>