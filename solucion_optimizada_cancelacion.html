<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úÖ Soluci√≥n OPTIMIZADA: Cancelaci√≥n con Historial Completo</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: linear-gradient(135deg, #e8f5e8, #f0f8ff);
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .bad-solution {
            background: #ffebee;
            border: 2px solid #f44336;
            border-radius: 10px;
            padding: 20px;
        }
        .good-solution {
            background: #e8f5e8;
            border: 2px solid #4CAF50;
            border-radius: 10px;
            padding: 20px;
        }
        .code {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 12px;
            font-family: monospace;
            font-size: 11px;
            margin: 10px 0;
        }
        .highlight {
            background: #fff3e0;
            border: 1px solid #ff9800;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        h1 { color: #2c5234; text-align: center; }
        h2 { color: #2196F3; }
        h3 { color: #ff9800; }
        .success { color: #4CAF50; font-weight: bold; }
        .error { color: #f44336; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚úÖ Soluci√≥n OPTIMIZADA: Cancelaci√≥n con Historial Completo</h1>
        
        <div class="highlight">
            <h2>üéØ Problema y Soluci√≥n Mejorada</h2>
            <p><strong>Tu observaci√≥n fue 100% correcta:</strong> La primera soluci√≥n eliminaba el historial completo del env√≠o, lo cual no es √≥ptimo para trazabilidad y auditor√≠a.</p>
            <p><strong>Nueva soluci√≥n:</strong> Mantener todo el historial y solo limpiar las referencias para liberar el stock.</p>
        </div>

        <h2>üìä Comparaci√≥n de Soluciones</h2>
        
        <div class="comparison">
            <div class="bad-solution">
                <h3>‚ùå Soluci√≥n Anterior (Eliminaci√≥n)</h3>
                <div class="code">
// MAL: Eliminar registros del env√≠o
DELETE FROM estados_items_movimientos...
DELETE FROM movimientos_items 
WHERE id_movimientos = ?

// RESULTADO:
‚úÖ Stock liberado
‚ùå Historial perdido
‚ùå No hay trazabilidad
‚ùå Env√≠o "desaparece"
                </div>
                <p class="error">Problemas:</p>
                <ul>
                    <li>Se pierde el historial del env√≠o</li>
                    <li>No se puede ver qu√© productos se cancelaron</li>
                    <li>Problemas de auditor√≠a</li>
                    <li>El env√≠o "desaparece" del sistema</li>
                </ul>
            </div>
            
            <div class="good-solution">
                <h3>‚úÖ Soluci√≥n Optimizada (Tu Propuesta)</h3>
                <div class="code">
// BIEN: Solo limpiar referencias
UPDATE movimientos_items 
SET id_movimientos_items_origen = NULL 
WHERE id_movimientos = ?

// RESULTADO:
‚úÖ Stock liberado
‚úÖ Historial completo
‚úÖ Trazabilidad total
‚úÖ Env√≠o visible (CANCELADO)
                </div>
                <p class="success">Ventajas:</p>
                <ul>
                    <li>Mantiene historial completo</li>
                    <li>Productos liberados al stock</li>
                    <li>Trazabilidad perfecta</li>
                    <li>Env√≠o queda como CANCELADO</li>
                </ul>
            </div>
        </div>

        <h2>üîß Implementaci√≥n de la Soluci√≥n Optimizada</h2>
        
        <div class="code">
public function cancelarEnvio($idEnvio, $motivo) {
    try {
        $this->db->beginTransaction();

        // 1. Obtener items del env√≠o
        $stmt = $this->db->prepare("
            SELECT id, id_movimientos_items_origen 
            FROM movimientos_items 
            WHERE id_movimientos = ?
        ");
        $stmt->execute([$idEnvio]);
        $items = $stmt->fetchAll(PDO::FETCH_ASSOC);

        // 2. Marcar items como CANCELADO (mantener historial)
        foreach ($items as $item) {
            $stmt = $this->db->prepare("
                INSERT INTO estados_items_movimientos (
                    id_estados, id_movimientos_items, fecha_alta, usuario_alta
                ) VALUES (4, ?, NOW(), ?)
            ");
            $stmt->execute([$item['id'], 'sistema']);
        }

        // 3. CLAVE: Limpiar referencias para liberar stock
        $stmt = $this->db->prepare("
            UPDATE movimientos_items 
            SET id_movimientos_items_origen = NULL 
            WHERE id_movimientos = ?
        ");
        $stmt->execute([$idEnvio]);

        // ‚úÖ RESULTADO: Stock liberado + Historial mantenido
        
        $this->db->commit();
        return true;
    } catch (Exception $e) {
        $this->db->rollBack();
        throw $e;
    }
}
        </div>

        <h2>üß† L√≥gica del Sistema</h2>
        
        <div class="highlight">
            <h3>üìã C√≥mo Funciona la Disponibilidad de Productos:</h3>
            <div class="code">
-- Query de productos disponibles:
SELECT ... FROM movimientos_items mi
WHERE mi.id_movimientos_items_origen IS NULL  -- Productos originales
AND NOT EXISTS (
    SELECT 1 FROM movimientos_items mi2 
    WHERE mi2.id_movimientos_items_origen = mi.id  -- No referenciados
)
AND estado_actual = 'NUEVO'
            </div>
            
            <p><strong>Al crear env√≠o:</strong></p>
            <ul>
                <li>Se crean nuevos registros con <code>id_movimientos_items_origen = X</code></li>
                <li>El producto original (X) ya no aparece como disponible</li>
            </ul>
            
            <p><strong>Al cancelar env√≠o (soluci√≥n optimizada):</strong></p>
            <ul>
                <li>Los items del env√≠o se marcan como CANCELADO (historial)</li>
                <li>Se limpia <code>id_movimientos_items_origen = NULL</code></li>
                <li>El producto original vuelve a estar disponible</li>
                <li><strong>El env√≠o sigue existiendo como CANCELADO</strong></li>
            </ul>
        </div>

        <h2>üéØ Beneficios de la Nueva Soluci√≥n</h2>
        
        <div class="comparison">
            <div style="background: #f0f8ff; border: 1px solid #2196F3; border-radius: 8px; padding: 15px;">
                <h3>üè¢ Para el Negocio:</h3>
                <ul>
                    <li>‚úÖ Auditor√≠a completa de env√≠os</li>
                    <li>‚úÖ Reportes hist√≥ricos precisos</li>
                    <li>‚úÖ Trazabilidad de productos</li>
                    <li>‚úÖ Control de inventario correcto</li>
                </ul>
            </div>
            
            <div style="background: #fff3e0; border: 1px solid #ff9800; border-radius: 8px; padding: 15px;">
                <h3>üíª Para el Sistema:</h3>
                <ul>
                    <li>‚úÖ Integridad referencial mantenida</li>
                    <li>‚úÖ Datos consistentes</li>
                    <li>‚úÖ Menos complejidad en queries</li>
                    <li>‚úÖ Base de datos m√°s robusta</li>
                </ul>
            </div>
        </div>

        <h2>üß™ Plan de Pruebas</h2>
        
        <div class="highlight">
            <h3>üìù Escenarios a Verificar:</h3>
            <ol>
                <li><strong>Stock inicial:</strong> Ver productos disponibles</li>
                <li><strong>Crear env√≠o:</strong> Productos salen del stock</li>
                <li><strong>Cancelar env√≠o:</strong> Productos vuelven al stock</li>
                <li><strong>Verificar historial:</strong> Env√≠o aparece como CANCELADO</li>
                <li><strong>Estados conservados:</strong> Items muestran historial completo</li>
            </ol>
        </div>

        <div style="background: #e8f5e8; border: 2px solid #4CAF50; border-radius: 10px; padding: 20px; margin: 20px 0; text-align: center;">
            <h2>üéâ ¬°Excelente Observaci√≥n!</h2>
            <p><strong>Tu soluci√≥n es mucho mejor que la inicial.</strong></p>
            <p>Mantener el historial completo mientras se libera el stock es la aproximaci√≥n correcta para un sistema de producci√≥n.</p>
            <p><span class="success">‚úÖ IMPLEMENTADO</span> - La funci√≥n ahora usa UPDATE en lugar de DELETE</p>
        </div>

        <h2>üìö Pr√≥ximos Pasos</h2>
        
        <div style="background: #f0f8ff; border: 1px solid #2196F3; border-radius: 8px; padding: 15px;">
            <ol>
                <li>‚úÖ <strong>Implementado:</strong> UPDATE id_movimientos_items_origen = NULL</li>
                <li>üß™ <strong>Probar:</strong> Crear env√≠o, cancelar, verificar stock + historial</li>
                <li>üìä <strong>Verificar:</strong> Reportes muestran env√≠os cancelados</li>
                <li>üéØ <strong>Documentar:</strong> Proceso para usuarios finales</li>
            </ol>
        </div>
    </div>
</body>
</html>